const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/ChatMessage-CDs-hT4k.js","assets/chat-components-oW8zPVyv.js","assets/rolldown-runtime-BBZsY560.js"])))=>i.map(i=>d[i]);
import{a as e}from"./rolldown-runtime-BBZsY560.js";import{i as t,n,r as o,v as r}from"./chat-components-oW8zPVyv.js";import{_ as a,a as i,c as s,d as c,f as l,g as d,h as u,i as g,l as p,m,n as h,o as f,p as x,r as b,s as v,t as y,u as S,v as C,y as N}from"./react-vendor-NdxlWO22.js";import{n as w,t as k}from"./services-BA4AZ_-N.js";var j=e(r()),B=e(o()),I=t({modal:{maxWidth:"700px",width:"95vw",minWidth:"400px",maxHeight:"85vh",overflowY:"auto"},modalMobile:{width:"100vw",height:"100vh",maxWidth:"none",maxHeight:"none",borderRadius:"0"},formGroup:{marginBottom:n.spacingVerticalXL},formLabel:{display:"block",marginBottom:n.spacingVerticalS,fontWeight:n.fontWeightMedium,color:n.colorNeutralForeground1,fontSize:n.fontSizeBase300},inputWithButton:{display:"flex",gap:n.spacingHorizontalS,alignItems:"stretch",width:"100%"},inputFlex:{flex:1},generateUuidBtn:{backgroundColor:n.colorNeutralBackground3,border:`1px solid ${n.colorNeutralStroke2}`,color:n.colorNeutralForeground1,padding:`${n.spacingVerticalS} ${n.spacingHorizontalM}`,borderRadius:n.borderRadiusMedium,cursor:"pointer",transition:`all ${n.durationNormal}`,display:"flex",alignItems:"center",justifyContent:"center",minWidth:"50px",flexShrink:0,":hover":{backgroundColor:n.colorNeutralBackground4}},fileUploadArea:{border:`2px dashed ${n.colorNeutralStroke2}`,borderRadius:n.borderRadiusMedium,padding:n.spacingVerticalXXL,textAlign:"center",transition:`border-color ${n.durationNormal}`,cursor:"pointer",position:"relative",minHeight:"120px",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",gap:n.spacingVerticalS},fileUploadAreaHover:{},fileUploadAreaDragOver:{backgroundColor:n.colorBrandBackground2},uploadIcon:{fontSize:n.fontSizeBase600,marginBottom:n.spacingVerticalXXS,display:"block"},fileName:{marginTop:n.spacingVerticalS,fontWeight:n.fontWeightMedium,color:n.colorNeutralForeground1,fontSize:n.fontSizeBase200},indexStatus:{textAlign:"center",minHeight:"24px",fontSize:n.fontSizeBase300,marginTop:n.spacingVerticalM,padding:`${n.spacingVerticalXS} ${n.spacingHorizontalM}`,borderRadius:n.borderRadiusSmall,backgroundColor:n.colorNeutralBackground2},indexStatusSuccess:{color:n.colorStatusSuccessForeground1},indexStatusError:{color:n.colorStatusDangerForeground1},indexStatusInfo:{color:n.colorBrandForeground1},dialogActions:{paddingTop:n.spacingVerticalL,gap:n.spacingHorizontalM,justifyContent:"flex-end"}});const E=({isOpen:e,onClose:t,userId:o})=>{const r=I(),[a,c]=(0,j.useState)(""),[l,u]=(0,j.useState)(""),[m,x]=(0,j.useState)(null),[C,N]=(0,j.useState)(!1),[w,E]=(0,j.useState)(""),[M,$]=(0,j.useState)(!1),[T,z]=(0,j.useState)(!1);j.useEffect(()=>{const e=()=>{z(window.innerWidth<768)};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]);const D=[r.modal,T&&r.modalMobile].filter(Boolean).join(" ");return(0,B.jsx)(f,{open:e,onOpenChange:(e,n)=>!n.open&&t(),children:(0,B.jsx)(h,{className:D,children:(0,B.jsxs)(g,{children:[(0,B.jsx)(b,{children:"Lập chỉ mục nội dung cuộc họp"}),(0,B.jsxs)(y,{children:[(0,B.jsxs)("div",{className:r.formGroup,children:[(0,B.jsx)("label",{className:r.formLabel,htmlFor:"meeting-id",children:"ID cuộc họp:"}),(0,B.jsxs)("div",{className:r.inputWithButton,children:[(0,B.jsx)(p,{className:r.inputFlex,id:"meeting-id",value:a,onChange:(e,t)=>c(t.value),placeholder:"Nhập ID cuộc họp (ví dụ: meeting-123)",required:!0}),(0,B.jsx)("button",{type:"button",className:r.generateUuidBtn,onClick:()=>{const e=k.generateUUID();c(e)},title:"Tạo UUID ngẫu nhiên",children:(0,B.jsx)(d,{})})]})]}),(0,B.jsxs)("div",{className:r.formGroup,children:[(0,B.jsx)("label",{className:r.formLabel,htmlFor:"meeting-transcript",children:"Bản ghi cuộc họp:"}),(0,B.jsx)(v,{id:"meeting-transcript",value:l,onChange:(e,t)=>u(t.value),placeholder:"Dán bản ghi cuộc họp ở đây...",rows:8,resize:"vertical",style:{width:"100%"}})]}),(0,B.jsxs)("div",{className:r.formGroup,children:[(0,B.jsx)("label",{className:r.formLabel,children:"Tệp ghi chú cuộc họp:"}),(0,B.jsxs)("div",{className:`${r.fileUploadArea} ${C?r.fileUploadAreaDragOver:""}`,onDrop:e=>{e.preventDefault(),N(!1);const t=e.dataTransfer.files;t.length>0&&x(t[0])},onDragOver:e=>{e.preventDefault(),N(!0)},onDragLeave:()=>N(!1),onClick:()=>document.getElementById("notes-file")?.click(),children:[(0,B.jsx)("span",{className:r.uploadIcon,children:"📎"}),(0,B.jsx)(s,{children:"Nhấp để chọn hoặc kéo thả tệp"}),(0,B.jsx)(s,{style:{fontSize:n.fontSizeBase200,opacity:.7},children:"Hỗ trợ: .txt, .pdf, .doc, .docx"}),(0,B.jsx)("input",{id:"notes-file",type:"file",style:{display:"none"},onChange:e=>{const t=e.target.files;t&&t.length>0&&x(t[0])},accept:".txt,.pdf,.doc,.docx"}),m&&(0,B.jsxs)("div",{className:r.fileName,children:["Đã chọn: ",m.name]})]})]}),w&&(0,B.jsx)("div",{className:r.indexStatus,children:(0,B.jsx)(s,{className:w.includes("successfully")?r.indexStatusSuccess:w.includes("error")||w.includes("Error")?r.indexStatusError:r.indexStatusInfo,children:w})})]}),(0,B.jsxs)(i,{className:r.dialogActions,children:[(0,B.jsx)(S,{appearance:"secondary",onClick:()=>{c(""),u(""),x(null),E(""),t()},disabled:M,children:"Hủy"}),(0,B.jsx)(S,{appearance:"primary",onClick:async()=>{if(a.trim())if(l.trim()||m){$(!0),E("Đang lập chỉ mục nội dung cuộc họp...");try{const e=await k.indexMeeting({meeting_id:a.trim(),transcript:l.trim()||void 0,meeting_note_file:m||void 0,current_user_id:o||""});if(!e.success)throw new Error(e.message||"Failed to index meeting");E(`Đã lập chỉ mục thành công cuộc họp: ${e.data?.processed_items?.join(", ")}`),setTimeout(()=>{t(),c(""),u(""),x(null),E("")},2e3)}catch(e){console.error("Error indexing meeting:",e),E(`Lỗi: ${e.message}`)}finally{$(!1)}}else E("Vui lòng cung cấp bản ghi hoặc tệp ghi chú cuộc họp");else E("Vui lòng nhập ID cuộc họp")},disabled:!a||M,children:M?"Đang lập chỉ mục...":"Lập chỉ mục cuộc họp"})]})]})})})};var M=t({sidebar:{width:"320px",minWidth:"280px",backgroundColor:n.colorNeutralBackground1,borderRight:`1px solid ${n.colorNeutralStroke2}`,display:"flex",flexDirection:"column",overflow:"hidden",transition:`all ${n.durationNormal}`,position:"relative"},sidebarCollapsed:{width:"0px",minWidth:"0px",opacity:0,transform:"translateX(-100%)",pointerEvents:"none"},sidebarMobile:{position:"fixed",top:"0",left:"0",height:"100%",zIndex:1e3,boxShadow:n.shadow64,transform:"translateX(-100%)"},sidebarMobileOpen:{transform:"translateX(0%)"},sidebarHeader:{padding:n.spacingVerticalL,borderBottom:`1px solid ${n.colorNeutralStroke2}`,backgroundColor:n.colorNeutralBackground2,display:"flex",flexDirection:"column",gap:n.spacingVerticalS},sidebarTitle:{fontSize:n.fontSizeBase400,fontWeight:n.fontWeightSemibold,color:n.colorNeutralForeground1,marginBottom:n.spacingVerticalM},newChatBtn:{width:"100%",marginTop:n.spacingVerticalXS},indexMeetingBtn:{width:"100%",marginTop:n.spacingVerticalXS},conversationsList:{flex:1,overflowY:"auto",padding:`${n.spacingVerticalXS} 0`},conversationItem:{padding:`${n.spacingVerticalM} ${n.spacingVerticalL}`,borderBottom:`1px solid ${n.colorNeutralStroke3}`,cursor:"pointer",transition:`background-color ${n.durationNormal}`,":hover":{backgroundColor:n.colorNeutralBackground3}},conversationItemActive:{backgroundColor:n.colorBrandBackground2,borderLeft:`3px solid ${n.colorBrandStroke1}`},conversationTitle:{fontSize:n.fontSizeBase300,fontWeight:n.fontWeightMedium,color:n.colorNeutralForeground1,marginBottom:n.spacingVerticalXXS,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},conversationMeta:{display:"flex",justifyContent:"space-between",alignItems:"center",fontSize:n.fontSizeBase200,color:n.colorNeutralForeground2},messageCount:{backgroundColor:n.colorNeutralBackground4,padding:`${n.spacingVerticalXXS} ${n.spacingHorizontalXS}`,borderRadius:n.borderRadiusCircular,fontSize:n.fontSizeBase100}});const $=({isOpen:e,isMobile:t,onToggle:o,activeConversationId:r,onConversationSelect:i,onConversationsLoad:c,onNewConversation:d})=>{const u=M(),g=(0,j.useRef)(null),[p,m]=(0,j.useState)([]),[h,f]=(0,j.useState)(!1),[x,b]=(0,j.useState)(!1),[v,y]=(0,j.useState)(null),[C,I]=(0,j.useState)(!1),$=v?.id;(0,j.useEffect)(()=>{w.hasAccessToken()&&T()},[]),(0,j.useEffect)(()=>{if(!t||!e||!g.current)return;const n=e=>{g.current&&!g.current.contains(e.target)&&o()};return document.addEventListener("mousedown",n),()=>{document.removeEventListener("mousedown",n)}},[t,e,o]);const T=async()=>{if(w.hasAccessToken())try{const e=await k.getUserInfo();e&&e.data&&y(e.data)}catch(e){console.error("Failed to load user info:",e)}},z=(0,j.useCallback)(async()=>{if(!C){b(!0);try{const e=await k.getConversations();m(e),I(!0),c&&c(e)}catch(e){console.error("Error loading conversations:",e),I(!0)}finally{b(!1)}}},[c,C]),D=(0,j.useCallback)(async()=>{if(!(C&&p.length>0)){b(!0);try{const e=await k.createConversation("New Conversation");m(t=>[e,...t]),I(!0),d&&d(e),i&&i(e.id)}catch(e){console.error("Error creating conversation:",e)}finally{b(!1)}}},[d,i,C,p.length]),R=(0,j.useCallback)(e=>{i&&i(e)},[i]),V=(0,j.useCallback)(()=>{f(!0)},[]),L=(0,j.useCallback)(()=>{f(!1)},[]);(0,j.useEffect)(()=>{$&&!C&&z()},[$,C,z]),(0,j.useEffect)(()=>{C&&!x&&0===p.length&&$&&D()},[C,x,p.length,$,D]);const A=[u.sidebar,!e&&u.sidebarCollapsed,t&&u.sidebarMobile,t&&e&&u.sidebarMobileOpen].filter(Boolean).join(" ");return(0,B.jsxs)("div",{className:A,ref:g,children:[t&&e&&(0,B.jsx)("div",{style:{position:"fixed",top:0,left:"320px",right:0,bottom:0,backgroundColor:"rgba(0, 0, 0, 0.5)",zIndex:999},onClick:o}),(0,B.jsxs)("div",{className:u.sidebarHeader,children:[(0,B.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:n.spacingVerticalM},children:[(0,B.jsx)(s,{className:u.sidebarTitle,children:"Cuộc trò chuyện"}),t&&(0,B.jsx)(S,{icon:(0,B.jsx)(l,{}),onClick:o,size:"small",appearance:"subtle"})]}),v&&(0,B.jsx)("div",{style:{padding:`${n.spacingVerticalM} ${n.spacingVerticalL}`,borderBottom:`1px solid ${n.colorNeutralStroke3}`,backgroundColor:n.colorNeutralBackground1},children:(0,B.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:n.spacingHorizontalS},children:[(0,B.jsx)("div",{style:{width:"40px",height:"40px",borderRadius:"50%",backgroundColor:n.colorBrandBackground,display:"flex",alignItems:"center",justifyContent:"center",fontSize:n.fontSizeBase400,fontWeight:n.fontWeightSemibold,color:n.colorNeutralForegroundInverted},children:v.first_name.charAt(0).toUpperCase()}),(0,B.jsxs)("div",{children:[(0,B.jsx)(s,{style:{fontSize:n.fontSizeBase300,fontWeight:n.fontWeightSemibold},children:v.name}),(0,B.jsx)("div",{children:(0,B.jsx)(s,{style:{fontSize:n.fontSizeBase200,color:n.colorNeutralForeground2},children:v.email})})]})]})}),(0,B.jsx)(S,{className:u.newChatBtn,icon:(0,B.jsx)(N,{}),onClick:D,children:"Trò chuyện mới"}),(0,B.jsx)(S,{className:u.indexMeetingBtn,icon:(0,B.jsx)(a,{}),onClick:V,children:"Lập chỉ mục cuộc họp"})]}),(0,B.jsx)("div",{className:u.conversationsList,children:$?x?(0,B.jsx)("div",{style:{padding:n.spacingVerticalL,textAlign:"center"},children:(0,B.jsx)(s,{children:"Đang tải cuộc trò chuyện..."})}):0===p.length?(0,B.jsx)("div",{style:{padding:n.spacingVerticalL,textAlign:"center"},children:(0,B.jsx)(s,{children:"Chưa có cuộc trò chuyện nào"})}):p.map(e=>(0,B.jsxs)("div",{className:`${u.conversationItem} ${r===e.id?u.conversationItemActive:""}`,onClick:()=>R(e.id),children:[(0,B.jsx)(s,{className:u.conversationTitle,children:e.title||"Cuộc trò chuyện chưa có tiêu đề"}),(0,B.jsxs)("div",{className:u.conversationMeta,children:[(0,B.jsx)(s,{children:k.formatDate(e.updated_at)}),e.message_count&&e.message_count>0&&(0,B.jsx)("span",{className:u.messageCount,children:e.message_count})]})]},e.id)):(0,B.jsx)("div",{style:{padding:n.spacingVerticalL,textAlign:"center"},children:(0,B.jsx)(s,{children:"Vui lòng đăng nhập để tiếp tục"})})}),(0,B.jsx)(E,{isOpen:h,onClose:L,userId:$})]})};function T(e){const t=function(e){const t=window.getSelection();if(!t||0===t.rangeCount)return null;const n=t.getRangeAt(0);if(!e.contains(n.startContainer))return null;const o=n.getClientRects();if(o&&o.length>0)return o[0];const r=document.createElement("span");r.textContent="​",n.insertNode(r);const a=r.getBoundingClientRect();r.parentNode?.removeChild(r);const i=document.createRange();return i.setStart(n.endContainer,n.endOffset),i.collapse(!0),t.removeAllRanges(),t.addRange(i),a}(e);return t?{left:t.left,top:t.bottom}:null}function z(e,t,n,o="short"){t.deleteContents();const r=function(e,t="short"){const n=document.createElement("span");return n.textContent="full"===t?`@{${e.type}}{${e.name}}`:`@${e.name}`,n.contentEditable="false",n.className="mention-chip",n.style.backgroundColor="var(--mention-bg, rgba(0,120,212,0.12))",n.style.border="1px solid var(--mention-border, rgba(0,120,212,0.4))",n.style.borderRadius="6px",n.style.padding="2px 6px",n.style.margin="0 1px",n.dataset.mentionId=e.id,n.dataset.mentionType=e.type,n.dataset.mentionName=e.name,n.dataset.mentionDisplayMode=t,n}(n,o);r.style.transition="background-color 0.2s ease, box-shadow 0.2s ease",r.style.backgroundColor="rgba(0,120,212,0.15)",r.style.boxShadow="0 0 0 2px #0078d4",window.setTimeout(()=>{r.style.backgroundColor="",r.style.boxShadow="",r.style.transition=""},800),t.insertNode(r);const a=document.createTextNode(" ");r.after(a);const i=window.getSelection();if(i){const e=document.createRange();e.setStart(a,1),e.collapse(!0),i.removeAllRanges(),i.addRange(e)}}var D=function({editorRef:e,search:t,limit:n=8}){const[o,r]=j.useState(!1),[a,i]=j.useState(null),[s,c]=j.useState([]),[l,d]=j.useState(-1),u=j.useRef(null),g=j.useRef(null),p=j.useCallback(()=>{r(!1),c([]),d(-1),u.current=null},[]),m=j.useCallback(()=>{const t=e.current;if(!t)return;const n=T(t);n&&i(n)},[e]),h=j.useCallback(async e=>{try{const o=await t(e);c(o.slice(0,n)),d(o.length>0?0:-1),r(!0)}catch{c([]),d(-1),r(!0)}},[t,n]),f=j.useCallback(()=>{const t=e.current;if(!t)return;const n=function(e){const t=window.getSelection();if(!t||0===t.rangeCount)return null;const n=t.getRangeAt(0).cloneRange();if(!e.contains(n.startContainer))return null;let o=n.startContainer,r=n.startOffset;if(o.nodeType!==Node.TEXT_NODE){const e=document.createTextNode("");n.insertNode(e),o=e,r=0}const a=(o.data||"").slice(0,r),i=a.lastIndexOf("@");if(-1===i)return null;if(0!==i&&!/[^\w]$/.test(a.slice(0,i)))return null;const s=a.slice(i+1),c=document.createRange();return c.setStart(o,i),c.setEnd(o,r),{range:c,query:s}}(t);n?(u.current=n.range,m(),g.current&&window.clearTimeout(g.current),g.current=window.setTimeout(()=>{h(n.query)},200)):p()},[e,m,h,p]),x=j.useCallback(t=>{const n=e.current,o=u.current;if(!n||!o)return!1;return z(0,o,{type:t.type,id:t.id,name:t.name},"short"),p(),!0},[]),b=j.useCallback(e=>!!o&&("Escape"===e.key?(e.preventDefault(),p(),!0):"ArrowDown"===e.key?(e.preventDefault(),d(e=>Math.min(e+1,Math.max(0,s.length-1))),!0):"ArrowUp"===e.key?(e.preventDefault(),d(e=>Math.max(0,e-1)),!0):"Enter"===e.key&&!e.shiftKey&&l>=0&&l<s.length?(e.preventDefault(),x(s[l])):("Enter"===e.key&&e.shiftKey,!1)),[o,s,l,p]);return j.useEffect(()=>()=>{g.current&&window.clearTimeout(g.current)},[]),{state:{open:o,position:a,items:s,focusedIndex:l},actions:{onInput:f,onKeyDown:b,setFocusedIndex:d,commit:x,close:p,updatePosition:m}}},R=t({surface:{position:"fixed",zIndex:1e3,backgroundColor:n.colorNeutralBackground1,border:`1px solid ${n.colorNeutralStroke1}`,borderRadius:n.borderRadiusSmall,boxShadow:n.shadow16,width:"300px",maxWidth:"90vw"},list:{maxHeight:"260px",overflow:"auto"},item:{display:"flex",alignItems:"center",gap:"6px",padding:"6px 8px",cursor:"pointer",fontSize:"12.5px"},focused:{backgroundColor:n.colorNeutralBackground3Hover},iconMeeting:{color:"#0078D4"},iconFile:{color:"#107C10"},iconProject:{color:"#C239B3"},name:{color:n.colorNeutralForeground1,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},empty:{padding:"8px 12px",color:n.colorNeutralForeground3,fontSize:"12px"}});function V({open:e,position:t,items:n,focusedIndex:o,onSelect:r,labels:a}){const i=R();return e&&t?(0,B.jsx)("div",{className:i.surface,style:{left:Math.max(8,t.left),bottom:Math.max(8,window.innerHeight-t.top)},role:"listbox",children:(0,B.jsx)("div",{className:i.list,children:0===n.length?(0,B.jsx)("div",{className:i.empty,children:a.noResults||"No results"}):n.map((e,t)=>{const n="meeting"===e.type?i.iconMeeting:"file"===e.type?i.iconFile:i.iconProject,a="meeting"===e.type?(0,B.jsx)(C,{className:n}):"file"===e.type?(0,B.jsx)(u,{className:n}):(0,B.jsx)(m,{className:n}),s=t===o;return(0,B.jsxs)("div",{className:`${i.item} ${s?i.focused:""}`,onMouseDown:t=>{t.preventDefault(),r(e)},role:"option","aria-selected":s,tabIndex:-1,children:[(0,B.jsx)("span",{children:a}),(0,B.jsx)("div",{className:i.name,children:e.name})]},`${e.type}-${e.id}`)})})}):null}var L=t({messageInputArea:{padding:n.spacingVerticalL,borderTop:`1px solid ${n.colorNeutralStroke2}`,backgroundColor:n.colorNeutralBackground1},messageInputContainer:{display:"flex",gap:n.spacingHorizontalS,alignItems:"flex-end"},messageInput:{flex:1,minHeight:"44px",maxHeight:"120px",padding:"8px 12px",border:`1px solid ${n.colorNeutralStroke1}`,borderRadius:n.borderRadiusMedium,backgroundColor:n.colorNeutralBackground1,resize:"none",outline:"none",overflowY:"auto"},sendBtn:{minHeight:"44px"},typingIndicator:{padding:`${n.spacingVerticalS} ${n.spacingVerticalL}`,fontSize:n.fontSizeBase300,color:n.colorNeutralForeground2,fontStyle:"italic"}});const A=({onSendMessage:e,disabled:t=!1,isTyping:o=!1})=>{const r=L(),a=(0,j.useRef)(null),[i,s]=(0,j.useState)(!0),[l,d]=(0,j.useState)(""),[u,g]=(0,j.useState)("");(0,j.useEffect)(()=>{const e=setTimeout(()=>{g(l),console.log("🔍 Debounced search:",l)},300);return()=>{clearTimeout(e)}},[l]);const p=(0,j.useCallback)(async e=>{if(d(e),!e.trim()||!u.trim())return[];try{console.log("🔍 Searching for mentions with query:",e,"debounced:",u),console.log("📤 About to call API with search term:",u);const t=await k.searchMeetings(u);return console.log("✅ Found meetings:",t.length,t.map(e=>({id:e.id,title:e.title}))),0===t.length?(console.log("❌ No meetings found for query:",u),console.log("🔍 This means the API returned empty results for the search term"),[]):t.slice(0,8).map(e=>({id:e.id,name:`@${e.title}`,type:"meeting"}))}catch(t){return console.error("💥 Error searching mentions:",t),[]}},[u]),{state:m,actions:h}=D({editorRef:a,search:p,limit:8}),f=async()=>{if(!i&&!t&&a.current)try{const{content:t,mentions:n}=function(e){let t="";const n=[],o=e=>{t+=e},r=a=>{if(a.nodeType===Node.ELEMENT_NODE){const i=a;if(i.dataset&&i.dataset.mentionId&&i.dataset.mentionType){const e=i.dataset.mentionName||"",r=i.dataset.mentionId||e,a=i.dataset.mentionType,s=`@{${a}}{${e}}`,c=t.length;return o(s),void n.push({entity_type:a,entity_id:r,offset_start:c,offset_end:c+s.length,length:s.length})}const s=i.tagName;if("BR"===s)return void o("\n");i!==e&&("block"!==window.getComputedStyle(i).display&&"DIV"!==s&&"P"!==s||t.endsWith("\n")||o("\n"));const c=Array.from(i.childNodes);for(const e of c)r(e);return}a.nodeType!==Node.TEXT_NODE||o(a.data)};for(const a of Array.from(e.childNodes))r(a);return t=t.replace(/\n{3,}/g,"\n\n"),{content:t.trim(),mentions:n}}(a.current);if(!t.trim())return;a.current.innerHTML="",s(!0),await e(t,n)}catch(n){console.error("Error sending message:",n)}};return(0,j.useEffect)(()=>{a.current&&a.current.focus()},[]),(0,B.jsxs)(B.Fragment,{children:[o&&(0,B.jsx)("div",{className:r.typingIndicator,children:"AI đang nhập..."}),(0,B.jsxs)("div",{className:r.messageInputArea,children:[(0,B.jsxs)("div",{className:r.messageInputContainer,children:[(0,B.jsx)("div",{ref:a,className:r.messageInput,contentEditable:!t,onInput:()=>{h.onInput(),s(""===a.current?.textContent?.trim())},onKeyDown:e=>{h.onKeyDown(e)||"Enter"!==e.key||e.shiftKey||(e.preventDefault(),f())},"data-placeholder":"Nhập tin nhắn của bạn ở đây... (Enter để gửi, Shift+Enter để xuống dòng, @ để tìm kiếm meetings)",style:{color:n.colorNeutralForeground1},suppressContentEditableWarning:!0}),(0,B.jsx)(S,{className:r.sendBtn,icon:(0,B.jsx)(c,{}),onClick:f,disabled:i||t,children:"Gửi"})]}),(0,B.jsx)(V,{open:m.open,position:m.position,items:m.items,focusedIndex:m.focusedIndex,onSelect:e=>{h.commit(e),s(!1)},onMove:e=>{"up"===e?h.setFocusedIndex(Math.max(0,m.focusedIndex-1)):h.setFocusedIndex(Math.min(m.items.length-1,m.focusedIndex+1))},onClose:h.close,labels:{loading:"Đang tìm kiếm...",noResults:"Không tìm thấy meeting nào phù hợp. Hãy thử từ khóa khác.",searchPlaceholder:"Tìm kiếm meetings..."}})]})]})};var F={};var W=(0,j.lazy)(()=>function(e,t,n){let o=Promise.resolve();if(t&&t.length>0){const e=document.getElementsByTagName("link"),a=document.querySelector("meta[property=csp-nonce]"),i=a?.nonce||a?.getAttribute("nonce");r=t.map(t=>{if((t=function(e){return"/"+e}(t))in F)return;F[t]=!0;const o=t.endsWith(".css"),r=o?'[rel="stylesheet"]':"";if(n)for(let n=e.length-1;n>=0;n--){const r=e[n];if(r.href===t&&(!o||"stylesheet"===r.rel))return}else if(document.querySelector(`link[href="${t}"]${r}`))return;const a=document.createElement("link");return a.rel=o?"stylesheet":"modulepreload",o||(a.as="script"),a.crossOrigin="",a.href=t,i&&a.setAttribute("nonce",i),document.head.appendChild(a),o?new Promise((e,n)=>{a.addEventListener("load",e),a.addEventListener("error",()=>n(new Error(`Unable to preload CSS for ${t}`)))}):void 0}),o=Promise.all(r.map(e=>Promise.resolve(e).then(e=>({status:"fulfilled",value:e}),e=>({status:"rejected",reason:e}))))}var r;function a(e){const t=new Event("vite:preloadError",{cancelable:!0});if(t.payload=e,window.dispatchEvent(t),!t.defaultPrevented)throw e}return o.then(t=>{for(const e of t||[])"rejected"===e.status&&a(e.reason);return e().catch(a)})}(()=>import("./ChatMessage-CDs-hT4k.js"),__vite__mapDeps([0,1,2])).then(e=>({default:e.ChatMessage}))),H=t({chatMain:{flex:1,display:"flex",flexDirection:"column",backgroundColor:n.colorNeutralBackground1,overflow:"hidden",width:"100%"},chatMainFullWidth:{width:"100%"},chatHeader:{padding:`${n.spacingVerticalL} ${n.spacingVerticalL}`,borderBottom:`1px solid ${n.colorNeutralStroke2}`,backgroundColor:n.colorNeutralBackground2,display:"flex",alignItems:"center",justifyContent:"space-between",gap:n.spacingHorizontalS},mobileToggleButton:{display:"none","@media (max-width: 767px)":{display:"flex"}},conversationTitleDisplay:{fontSize:n.fontSizeBase400,fontWeight:n.fontWeightSemibold,color:n.colorNeutralForeground1,display:"flex",alignItems:"center",gap:n.spacingHorizontalS},connectionStatus:{width:"12px",height:"12px",borderRadius:"50%",display:"inline-block"},connectionStatusConnected:{backgroundColor:n.colorStatusSuccessBackground1},connectionStatusDisconnected:{backgroundColor:n.colorStatusDangerBackground1},chatMessages:{flex:1,overflowY:"auto",padding:n.spacingVerticalL},messagesContainer:{display:"flex",flexDirection:"column",gap:n.spacingVerticalM},messageItem:{display:"flex",flexDirection:"column",gap:n.spacingVerticalXXS},messageContent:{padding:n.spacingVerticalS,borderRadius:n.borderRadiusMedium,maxWidth:"70%",wordWrap:"break-word"},messageUser:{alignSelf:"flex-end",backgroundColor:n.colorBrandBackground,color:n.colorNeutralForegroundOnBrand},messageAssistant:{alignSelf:"flex-start",backgroundColor:n.colorNeutralBackground3,color:n.colorNeutralForeground1}});const _=({sidebarOpen:e,isMobile:t,onToggleSidebar:o,activeConversationId:r})=>{const a=H(),i=[a.chatMain,!e&&!t&&a.chatMainFullWidth].filter(Boolean).join(" "),[c,l]=(0,j.useState)([]),[d,u]=(0,j.useState)(!1),[g,p]=(0,j.useState)(!1),[m,h]=(0,j.useState)("Chọn một cuộc trò chuyện để bắt đầu chat"),[f,b]=(0,j.useState)(null),v=(0,j.useRef)(null);(0,j.useEffect)(()=>{v.current?.scrollIntoView({behavior:"smooth"})},[c]),(0,j.useEffect)(()=>(r?(y(r),C(r)):(l([]),h("Chọn một cuộc trò chuyện để bắt đầu chat"),N()),()=>{N()}),[r]),(0,j.useEffect)(()=>()=>{N()},[]);const y=async e=>{try{const t=await k.getConversationMessages(e);l(t),h("Cuộc trò chuyện đang hoạt động")}catch(t){console.error("Error loading conversation messages:",t),h("Lỗi khi tải cuộc trò chuyện")}},C=e=>{N();try{const t=k.connectToConversation(e,e=>{l(t=>[...t,e])});b(t),p(!0)}catch(t){console.error("Error connecting to real-time updates:",t),p(!1)}},N=()=>{f&&(k.disconnectSSE(f),b(null),p(!1))};return(0,B.jsxs)("div",{className:i,children:[(0,B.jsx)("div",{className:a.chatHeader,children:(0,B.jsxs)("div",{className:a.conversationTitleDisplay,children:[t&&(0,B.jsx)(S,{className:a.mobileToggleButton,icon:(0,B.jsx)(x,{}),onClick:o,size:"small",appearance:"subtle"}),(0,B.jsx)("span",{className:`${a.connectionStatus} ${g?a.connectionStatusConnected:a.connectionStatusDisconnected}`,title:g?"Đã kết nối":"Mất kết nối"}),(0,B.jsx)(s,{children:m})]})}),(0,B.jsx)("div",{className:a.chatMessages,children:(0,B.jsxs)("div",{className:a.messagesContainer,children:[c.map(e=>(0,B.jsx)(j.Suspense,{fallback:(0,B.jsx)("div",{style:{padding:n.spacingVerticalM,textAlign:"center"},children:"Đang tải tin nhắn..."}),children:(0,B.jsx)(W,{message:e,user:void 0})},e.id)),(0,B.jsx)("div",{ref:v})]})}),(0,B.jsx)(A,{onSendMessage:async(e,t)=>{if(!r)return;const n={id:`temp-${Date.now()}`,message_type:"user",content:e,created_at:(new Date).toISOString()};l(e=>[...e,n]);try{u(!0);const n=await k.resolveMeetingMentions(t);await k.sendMessage(r,{content:e,mentions:n})}catch(o){throw console.error("Error sending message:",o),u(!1),l(e=>e.filter(e=>e.id!==n.id)),o}},disabled:!r,isTyping:d})]})};var O=t({chatContainer:{display:"flex",height:"100vh",width:"100%",backgroundColor:n.colorNeutralBackground1,position:"relative"},chatContainerEmbedded:{borderRadius:n.borderRadiusMedium,overflow:"hidden"}});const X=({isEmbedded:e=!1})=>{const t=O(),[n,o]=(0,j.useState)(!1),[r,a]=(0,j.useState)(!0),[i,s]=(0,j.useState)(null);(0,j.useEffect)(()=>{const e=()=>{const e=window.innerWidth<768;o(e),a(!e)};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]);const c=(0,j.useCallback)(e=>{if(e.length>0&&!i){const t=e.sort((e,t)=>new Date(t.updated_at).getTime()-new Date(e.updated_at).getTime())[0];s(t.id)}},[i]),l=(0,j.useCallback)(e=>{s(e.id)},[]),d=(0,j.useCallback)(e=>{s(e)},[]),u=(0,j.useCallback)(()=>{a(e=>!e)},[]);return(0,B.jsxs)("div",{className:`${t.chatContainer} ${e?t.chatContainerEmbedded:""}`,children:[(0,B.jsx)($,{isOpen:r,isMobile:n,onToggle:u,activeConversationId:i,onConversationSelect:d,onConversationsLoad:c,onNewConversation:l}),(0,B.jsx)(_,{sidebarOpen:r,isMobile:n,onToggleSidebar:u,activeConversationId:i,onConversationChange:d})]})};export{X as t};